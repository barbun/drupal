<?php

/**
 * @file
 * Add cron support for quant processing.
 */

use Drupal\quant\Seed;
use Drupal\Core\Form\FormState;
use Drupal\quant\Event\CollectEntitiesEvent;
use Drupal\quant\Event\CollectFilesEvent;
use Drupal\quant\Event\CollectRedirectsEvent;
use Drupal\quant\Event\CollectRoutesEvent;
use Drupal\quant\Event\QuantCollectionEvents;
use Drupal\quant\Plugin\QueueItem\RouteItem;
use Drupal\node\Entity\Node;

/**
 * Implements hook_cron().
 */
function quant_cron_cron() {

  // Quant cron only supported via CLI.
  if (PHP_SAPI != 'cli') {
    return;
  }

  // Load the settings form.
  $form_state = new FormState();
  $form_state->setRebuild();
  \Drupal::formBuilder()->buildForm('Drupal\quant_cron\Form\CronSettingsForm', $form_state);
  $event_dispatcher = \Drupal::service('event_dispatcher');

  $batch = [
    'title' => t('Exporting to Quant...'),
    'operations' => [],
    'init_message'     => t('Commencing'),
    'progress_message' => t('Processed @current out of @total.'),
    'error_message'    => t('An error occurred during processing'),
    'finished' => '\Drupal\quant\Seed::finishedSeedCallback',
  ];


  if ($form_state->getValue('entity_node')) {
    $query = \Drupal::entityTypeManager()->getStorage('node')->getQuery();

    $bundles = $form_state->getValue('entity_node_bundles');

    if (!empty($bundles)) {
      $bundles = array_filter($bundles);
      if (!empty($bundles)) {
        $query->condition('type', array_keys($bundles), 'IN');
      }
    }

    $entities = $query->execute();
    foreach ($entities as $vid => $nid) {
      $entity = Node::load($nid);
      Seed::seedNode($entity);
      \Drupal::messenger()->addMessage("quant_cron sending nid: $nid");
    }
  }

  if ($form_state->getValue('routes')) {
    foreach (explode(PHP_EOL, $form_state->getValue('routes_textarea')) as $route) {
      if (strpos((trim($route)), '/') !== 0) {
        continue;
      }
      \Drupal::messenger()->addMessage("quant_cron sending route: $route");
      $item = new RouteItem(['route' => $route]);
      $item->send();
    }
  }

}
