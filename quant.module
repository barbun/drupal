<?php

/**
 * @file
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Session\AccountInterface;
use Drupal\node\NodeInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\quant\Seed;

/**
 * Implements hook_node_insert().
 */
function quant_node_insert(EntityInterface $entity) {
  $disable_drafts = \Drupal::config('quant.settings')->get('disable_content_drafts');
  if ($disable_drafts && !$entity->isPublished()) {
    return;
  }
  drupal_register_shutdown_function('_quant_post_node_entity_op', $entity);
}

/**
 * Implements hook_node_update().
 */
function quant_node_update(EntityInterface $entity) {
  $disable_drafts = \Drupal::config('quant.settings')->get('disable_content_drafts');
  if ($disable_drafts && !$entity->isPublished()) {
    return;
  }
  drupal_register_shutdown_function('_quant_post_node_entity_op', $entity);
}

/**
 * Implements hook_node_access().
 *
 * Grants access to users to view any node/revision.
 * Access control is restricted in the route definition.
 */
function quant_node_access(NodeInterface $node, $op, AccountInterface $account) {
  if (!\Drupal::request()->query->has('quant_revision')) {
    return AccessResult::neutral();
  }

  if (\Drupal::service('quant.token_manager')->validate($node->id())) {
    return AccessResult::allowed();
  }

  return AccessResult::forbidden();
}


/**
 * Implements hook_redirect_presave().
 */
function quant_redirect_presave($redirect) {
  Seed::seedRedirect($redirect);
}

/**
 * Implements hook_redirect_delete().
 */
function quant_redirect_delete($redirect) {
  Seed::deleteRedirect($redirect);
}

/**
 * Post entity operation hook.
 *
 * This should be registered as a shutdown function so that it
 * can operate after the db_transaction has finished.
 */
function _quant_post_node_entity_op($entity) {
  Seed::seedNode($entity);
}

/**
 * Post redirect operation hook (add/update).
 */
function _quant_post_redirect_update_op($redirect) {
  Seed::seedRedirect($redirect);
}

/**
 * Post redirect operation hook (delete).
 */
function _quant_post_redirect_delete_op($redirect) {

}

